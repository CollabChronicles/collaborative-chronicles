<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="img-src data: https:;">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Collaborative Chronicles - Write!</title>
  <link rel="stylesheet" href="/collaborative-chronicles/style.css" />
  <style>
    #cancelEditBtn, #cancelEditBtnStory {
      margin-left: 8px;
      cursor: pointer;
    }
    #loreStatusMessage, #storyStatusMessage {
      margin-top: 8px;
      font-weight: bold;
    }
    #wordCounter {
      margin-top: 6px;
      font-style: italic;
      color: #555;
    }
    #recentLoreList {
      margin-top: 12px;
      padding-left: 20px;
    }
    #recentLoreList li {
      list-style-type: disc;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Collaborative Chronicles</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="story.html">The Story</a> |
      <a href="lore.html">The Lore</a> |
      <a href="write.html">Write!</a> |
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <main>
    <h2>Add to the World</h2>
    <p>Contribute new lore entries or add to the ongoing story below! Fantasy, sci-fi, mystery... any style is welcome, but please keep it original and avoid copyrighted materials. To maintain narrative continuity, all new Lore entries must reference at least one existing Lore, and Story entries must reference a recently referenced Lore item (shown below).</p>

    <section id="toggleSection" class="toggle-buttons">
      <button class="toggle-button active" id="loreToggle">Add Lore</button>
      <button class="toggle-button" id="storyToggle">Add Story</button>
    </section>

    <!-- Lore Form -->
    <section id="loreFormSection">
      <form id="loreForm">
        <label for="loreName">Name:</label>
        <input type="text" id="loreName" required />

        <label for="loreCategory">Category:</label>
        <select id="loreCategory" required>
          <option value="Character">Character</option>
          <option value="Place">Place</option>
          <option value="Faction">Faction</option>
          <option value="Object">Object</option>
          <option value="Tale">Tale</option>
          <option value="Miscellaneous">Miscellaneous</option>
        </select>

        <label for="loreDescription">Description:</label>
        <textarea id="loreDescription" rows="5" required></textarea>

        <label for="loreReferences">References (comma-separated, must include one existing lore):</label>
        <input type="text" id="loreReferences" required />

        <input class="button-standard" type="submit" value="Submit Lore" />
        <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
        <p id="loreStatusMessage"></p>
      </form>
    </section>

    <!-- Story Form -->
    <section id="storyFormSection" style="display: none;">
      <form id="storyForm">
        <label for="storyName">Title (optional):</label>
        <input type="text" id="storyName" />

        <label for="storyContent">Content (must mention at least one reference):</label>
        <textarea id="storyContent" rows="10" required></textarea>

        <div id="wordCounter">0 words | suggested donation: 0 cents</div>
        <p></p>

        <label for="storyReferences">References (comma-separated, must include one recent lore):</label>
        <input type="text" id="storyReferences" required />

        <input class="button-standard" type="submit" value="Submit Story" />
        <button type="button" id="cancelEditBtnStory" style="display:none;">Cancel Edit</button>
        <p id="storyStatusMessage"></p>
      </form>

      <h3>Recently Referenced Lore (choose from these):</h3>
      <ul id="recentLoreList">
        <li>Loading...</li>
      </ul>
    </section>
  </main>

  <footer>
    <p>2025 Collaborative Chronicles</p>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJNGG0dKMpNwiFT-bomUR0ufSUIaoksFE",
      authDomain: "collaborative-chronicles.firebaseapp.com",
      projectId: "collaborative-chronicles",
      storageBucket: "collaborative-chronicles.appspot.com",
      messagingSenderId: "127752938400",
      appId: "1:127752938400:web:9fa9b38012352d02ed7ac5",
      measurementId: "G-0HXV6NGHQP"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loreToggle = document.getElementById('loreToggle');
    const storyToggle = document.getElementById('storyToggle');
    const loreFormSection = document.getElementById('loreFormSection');
    const storyFormSection = document.getElementById('storyFormSection');
    const loreStatusMessage = document.getElementById('loreStatusMessage');
    const storyStatusMessage = document.getElementById('storyStatusMessage');
    const storyContent = document.getElementById('storyContent');
    const wordCounter = document.getElementById('wordCounter');
    const recentLoreList = document.getElementById('recentLoreList');
    const loreForm = document.getElementById('loreForm');
    const storyForm = document.getElementById('storyForm');

    let currentUser = null;
    let currentUsername = null;
    let recentLoreNamesSet = new Set();

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUsername();
      } else {
        currentUser = null;
        currentUsername = null;
      }
    });

    async function loadUsername() {
      if (!currentUser) return;
      const doc = await db.collection('users').doc(currentUser.uid).get();
      currentUsername = doc.exists && doc.data().username
        ? doc.data().username
        : currentUser.email.split('@')[0];
    }

    storyContent.addEventListener('input', () => {
      const words = countWords(storyContent.value);
      const cents = words;
      wordCounter.textContent = `${words} word${words !== 1 ? 's' : ''} | suggested donation: ${cents} cent${cents !== 1 ? 's' : ''}`;
    });

    function countWords(text) {
      if (!text) return 0;
      return text.trim().split(/\s+/).filter(word => word.length > 0).length;
    }

    loreToggle.addEventListener('click', () => {
      loreFormSection.style.display = 'block';
      storyFormSection.style.display = 'none';
      loreToggle.classList.add('active');
      storyToggle.classList.remove('active');
      loreToggle.style.opacity = '1';
      storyToggle.style.opacity = '0.5';
    });

    storyToggle.addEventListener('click', () => {
      loreFormSection.style.display = 'none';
      storyFormSection.style.display = 'block';
      storyToggle.classList.add('active');
      loreToggle.classList.remove('active');
      storyToggle.style.opacity = '1';
      loreToggle.style.opacity = '0.5';
    });

    loreFormSection.style.display = 'block';
    storyFormSection.style.display = 'none';
    loreToggle.classList.add('active');
    storyToggle.classList.remove('active');
    loreToggle.style.opacity = '1';
    storyToggle.style.opacity = '0.5';

    // Load Recently Referenced Lore
    async function loadRecentLore() {
      try {
        // Get lore items with most recent timestamp among those *referenced*
        let loreRefCounts = new Map();
        const storySnapshot = await db.collection('story').get();
        storySnapshot.forEach(doc => {
          const refs = doc.data().references || [];
          refs.forEach(r => {
            if (r) loreRefCounts.set(r, (loreRefCounts.get(r) || 0) + 1);
          });
        });

        const sortedRefs = Array.from(loreRefCounts.entries())
          .sort((a, b) => b[1] - a[1])
          .map(entry => entry[0]);

        let finalLoreNames = [];

        // Add up to 20 from most referenced
        for (let name of sortedRefs) {
          if (finalLoreNames.length >= 20) break;
          finalLoreNames.push(name);
        }

        if (finalLoreNames.length < 20) {
          // Fill with recently created lore
          const moreLore = await db.collection('lore')
            .orderBy('timestamp', 'desc')
            .limit(20 - finalLoreNames.length)
            .get();

          moreLore.forEach(doc => {
            const name = doc.data().name;
            if (name && !finalLoreNames.includes(name)) {
              finalLoreNames.push(name);
            }
          });
        }

        // Display them
        if (finalLoreNames.length) {
          recentLoreList.innerHTML = finalLoreNames
            .map(name => `<li>${name}</li>`)
            .join('');
          recentLoreNamesSet = new Set(finalLoreNames.map(n => n.toLowerCase()));
        } else {
          recentLoreList.innerHTML = '<li>None found.</li>';
          recentLoreNamesSet = new Set();
        }

      } catch (error) {
        console.error(error);
        recentLoreList.innerHTML = '<li>Error loading recently referenced lore.</li>';
      }
    }

    loadRecentLore();

    // SUBMIT HANDLERS
    loreForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loreStatusMessage.textContent = '';

      if (!currentUser || !currentUsername) {
        loreStatusMessage.textContent = 'You must be signed in to submit.';
        return;
      }

      const name = document.getElementById('loreName').value.trim();
      const category = document.getElementById('loreCategory').value;
      const description = document.getElementById('loreDescription').value.trim();
      const references = document.getElementById('loreReferences').value.split(',').map(s => s.trim()).filter(s => s.length > 0);

      if (!name || !category || !description || references.length === 0) {
        loreStatusMessage.textContent = 'Please fill out all fields and include at least one reference.';
        return;
      }

      try {
        await db.collection('lore').add({
          name,
          category,
          description,
          references,
          author: currentUsername,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        loreStatusMessage.style.color = 'green';
        loreStatusMessage.textContent = 'Lore submitted successfully!';
        loreForm.reset();
      } catch (err) {
        loreStatusMessage.style.color = 'red';
        loreStatusMessage.textContent = 'Error submitting lore. Please try again.';
        console.error(err);
      }
    });

    storyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      storyStatusMessage.textContent = '';

      if (!currentUser || !currentUsername) {
        storyStatusMessage.textContent = 'You must be signed in to submit.';
        return;
      }

      const name = document.getElementById('storyName').value.trim();
      const content = document.getElementById('storyContent').value.trim();
      const references = document.getElementById('storyReferences').value.split(',').map(s => s.trim()).filter(s => s.length > 0);

      if (!content || references.length === 0) {
        storyStatusMessage.textContent = 'Please fill out all fields and include at least one reference.';
        return;
      }

      // NEW: Enforce that at least one reference is in the recent set
      const hasValidReference = references.some(ref => recentLoreNamesSet.has(ref.toLowerCase()));
      if (!hasValidReference) {
        storyStatusMessage.style.color = 'red';
        storyStatusMessage.textContent = 'You must include at least one of the recently referenced lore items shown below.';
        return;
      }

      try {
        await db.collection('story').add({
          name: name || null,
          content,
          references,
          author: currentUsername,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        storyStatusMessage.style.color = 'green';
        storyStatusMessage.textContent = 'Story submitted successfully!';
        storyForm.reset();
        wordCounter.textContent = '0 words | suggested donation: 0 cents';
      } catch (err) {
        storyStatusMessage.style.color = 'red';
        storyStatusMessage.textContent = 'Error submitting story. Please try again.';
        console.error(err);
      }
    });
  </script>
</body>
</html>
