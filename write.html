<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Security-Policy" content="img-src data: https:;">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Collaborative Chronicles - Write!</title>
  <link rel="stylesheet" href="/collaborative-chronicles/style.css" />
  <style>
    #cancelEditBtn {
      margin-left: 8px;
      cursor: pointer;
    }
    #loreStatusMessage, #storyStatusMessage {
      margin-top: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Collaborative Chronicles</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="story.html">The Story</a> |
      <a href="lore.html">The Lore</a> |
      <a href="write.html">Write!</a> |
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <main>
    <h2>Add to the World</h2>
    <p>Contribute new lore entries or add to the ongoing story below! Add an adventurous character, a scheming faction, a legendary artifact, or anything else you can imagine! Fantasy, sci-fi, mystery, noir, serious, humorous, grimdark, noir, whimsicial...any style goes here.</p>
    <p>In order to encourage writer collaboration and maintain narrative cohesiveness, we require all new Lore entries to reference an already existing Lore entry, and all new Story entries to reference a recently referenced Lore entry. This ensures narrative continuity and interconnectivity of all elements of the world. </p>
    <p>Collaborative Chronicles is a world for everyone. Inappropriate or hateful additions will be removed promptly. </p>

    <section id="toggleSection" class="toggle-buttons">
      <button class="toggle-button active" id="loreToggle">Add Lore</button>
      <button class="toggle-button" id="storyToggle">Add Story</button>
    </section>

    <!-- Lore Form -->
    <section id="loreFormSection">
      <form id="loreForm">
        <label for="loreName">Name:</label>
        <input type="text" id="loreName" required />

        <label for="loreCategory">Category:</label>
        <select id="loreCategory" required>
          <option value="Character">Character</option>
          <option value="Place">Place</option>
          <option value="Faction">Faction</option>
          <option value="Object">Object</option>
          <option value="Tale">Tale</option>
          <option value="Miscellaneous">Miscellaneous</option>
        </select>

        <label for="loreDescription">Description:</label>
        <textarea id="loreDescription" rows="5" required></textarea>

        <label for="loreReferences">References (comma-separated, must include one existing lore):</label>
        <input type="text" id="loreReferences" required />

        <input class="button-standard" type="submit" value="Submit Lore" />
        <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
        <p id="loreStatusMessage"></p>
      </form>
    </section>

    <!-- Story Form -->
    <section id="storyFormSection" style="display: none;">
      <form id="storyForm">
        <label for="storyName">Title (optional):</label>
        <input type="text" id="storyName" />

        <label for="storyContent">Content (must mention at least one reference):</label>
        <textarea id="storyContent" rows="10" required></textarea>

        <label for="storyReferences">References (comma-separated, must include one recent lore):</label>
        <input type="text" id="storyReferences" required />

        <input class="button-standard" type="submit" value="Submit Story" />
        <button type="button" id="cancelEditBtnStory" style="display:none;">Cancel Edit</button>
        <p id="storyStatusMessage"></p>
      </form>
    </section>
  </main>

  <footer>
    <p>2025 Collaborative Chronicles</p>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJNGG0dKMpNwiFT-bomUR0ufSUIaoksFE",
      authDomain: "collaborative-chronicles.firebaseapp.com",
      projectId: "collaborative-chronicles",
      storageBucket: "collaborative-chronicles.appspot.com",
      messagingSenderId: "127752938400",
      appId: "1:127752938400:web:9fa9b38012352d02ed7ac5",
      measurementId: "G-0HXV6NGHQP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const loreToggle = document.getElementById('loreToggle');
    const storyToggle = document.getElementById('storyToggle');
    const loreFormSection = document.getElementById('loreFormSection');
    const storyFormSection = document.getElementById('storyFormSection');

    const loreForm = document.getElementById('loreForm');
    const loreName = document.getElementById('loreName');
    const loreCategory = document.getElementById('loreCategory');
    const loreDescription = document.getElementById('loreDescription');
    const loreReferences = document.getElementById('loreReferences');
    const loreStatusMessage = document.getElementById('loreStatusMessage');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    const storyForm = document.getElementById('storyForm');
    const storyName = document.getElementById('storyName');
    const storyContent = document.getElementById('storyContent');
    const storyReferences = document.getElementById('storyReferences');
    const storyStatusMessage = document.getElementById('storyStatusMessage');
    const cancelEditBtnStory = document.getElementById('cancelEditBtnStory');

    // Toggle forms
    loreToggle.addEventListener('click', () => {
      loreFormSection.style.display = 'block';
      storyFormSection.style.display = 'none';
      loreToggle.classList.add('active');
      storyToggle.classList.remove('active');
      loreToggle.style.opacity = '1';
      storyToggle.style.opacity = '0.5';
    });

    storyToggle.addEventListener('click', () => {
      loreFormSection.style.display = 'none';
      storyFormSection.style.display = 'block';
      storyToggle.classList.add('active');
      loreToggle.classList.remove('active');
      storyToggle.style.opacity = '1';
      loreToggle.style.opacity = '0.5';
    });

    // Initialize toggles state
    loreFormSection.style.display = 'block';
    storyFormSection.style.display = 'none';
    loreToggle.classList.add('active');
    storyToggle.classList.remove('active');
    loreToggle.style.opacity = '1';
    storyToggle.style.opacity = '0.5';

    // Parse URL params to check for edit mode
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search.substring(1);
      queryString.split("&").forEach(pair => {
        const [key, value] = pair.split("=");
        if (key) params[key] = decodeURIComponent(value);
      });
      return params;
    }
    const queryParams = getQueryParams();
    const isEditMode = (queryParams.edit === 'lore' || queryParams.edit === 'story') && queryParams.id;
    const editCollection = queryParams.edit;
    const editDocId = queryParams.id;

    let currentUser = null;
    let currentUsername = null;

    // Check auth
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Redirect to profile to sign in
        window.location.href = 'profile.html';
        return;
      }
      currentUser = user;
      await loadUsername();

      if (isEditMode) {
        loadEntryForEdit(editCollection, editDocId);
      }
    });

    async function loadUsername() {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      if (userDoc.exists && userDoc.data().username) {
        currentUsername = userDoc.data().username;
      } else {
        currentUsername = currentUser.email.split('@')[0];
        await db.collection('users').doc(currentUser.uid).set({ username: currentUsername });
      }
    }

    async function loadEntryForEdit(collection, docId) {
      try {
        const doc = await db.collection(collection).doc(docId).get();
        if (!doc.exists) {
          alert('Entry not found for editing.');
          return;
        }
        const data = doc.data();
        if (collection === 'lore') {
          loreName.value = data.name || '';
          loreCategory.value = data.category || 'Miscellaneous';
          loreDescription.value = data.description || '';
          loreReferences.value = (data.references || []).join(', ');
          // Show lore form, hide story
          loreFormSection.style.display = 'block';
          storyFormSection.style.display = 'none';
          loreToggle.classList.add('active');
          storyToggle.classList.remove('active');
          loreToggle.style.opacity = '1';
          storyToggle.style.opacity = '0.5';

          loreForm.querySelector('input[type="submit"]').value = 'Save Changes';
          cancelEditBtn.style.display = 'inline-block';
        } else if (collection === 'story') {
          storyName.value = data.name || '';
          storyContent.value = data.content || '';
          storyReferences.value = (data.references || []).join(', ');
          // Show story form, hide lore
          storyFormSection.style.display = 'block';
          loreFormSection.style.display = 'none';
          storyToggle.classList.add('active');
          loreToggle.classList.remove('active');
          storyToggle.style.opacity = '1';
          loreToggle.style.opacity = '0.5';

          storyForm.querySelector('input[type="submit"]').value = 'Save Changes';
          cancelEditBtnStory.style.display = 'inline-block';
        }
      } catch (error) {
        console.error('Error loading entry:', error);
        alert('Failed to load entry for editing.');
      }
    }

    // Cancel edit buttons
    cancelEditBtn.addEventListener('click', () => {
      window.location.href = 'write.html'; // reload without query to reset form
    });
    cancelEditBtnStory.addEventListener('click', () => {
      window.location.href = 'write.html'; // reload without query
    });

    // Lore form submit
    loreForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loreStatusMessage.textContent = '';

      const nameVal = loreName.value.trim();
      const categoryVal = loreCategory.value;
      const descriptionVal = loreDescription.value.trim();
      const referencesArr = loreReferences.value.split(',').map(r => r.trim()).filter(r => r);

      if (!nameVal || !categoryVal || !descriptionVal || referencesArr.length === 0) {
        loreStatusMessage.textContent = 'Please fill all fields and add at least one reference.';
        loreStatusMessage.style.color = 'red';
        return;
      }

      try {
        if (isEditMode && editCollection === 'lore') {
          // Update existing doc
          await db.collection('lore').doc(editDocId).update({
            name: nameVal,
            category: categoryVal,
            description: descriptionVal,
            references: referencesArr,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            author: currentUsername
          });
          loreStatusMessage.style.color = 'green';
          loreStatusMessage.textContent = 'Lore entry updated successfully!';
          setTimeout(() => window.location.href = 'profile.html', 1500);
        } else {
          // Create new doc
          await db.collection('lore').add({
            name: nameVal,
            category: categoryVal,
            description: descriptionVal,
            references: referencesArr,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            author: currentUsername
          });
          loreStatusMessage.style.color = 'green';
          loreStatusMessage.textContent = 'Lore entry submitted successfully!';
          loreForm.reset();
        }
      } catch (error) {
        loreStatusMessage.style.color = 'red';
        loreStatusMessage.textContent = 'Error submitting lore entry: ' + error.message;
      }
    });

    // Story form submit
    storyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      storyStatusMessage.textContent = '';

      const nameVal = storyName.value.trim();
      const contentVal = storyContent.value.trim();
      const referencesArr = storyReferences.value.split(',').map(r => r.trim()).filter(r => r);

      if (!contentVal || referencesArr.length === 0) {
        storyStatusMessage.textContent = 'Content and references are required.';
        storyStatusMessage.style.color = 'red';
        return;
      }

      try {
        if (isEditMode && editCollection === 'story') {
          // Update existing doc
          await db.collection('story').doc(editDocId).update({
            name: nameVal,
            content: contentVal,
            references: referencesArr,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            author: currentUsername
          });
          storyStatusMessage.style.color = 'green';
          storyStatusMessage.textContent = 'Story entry updated successfully!';
          setTimeout(() => window.location.href = 'profile.html', 1500);
        } else {
          // Create new doc
          await db.collection('story').add({
            name: nameVal,
            content: contentVal,
            references: referencesArr,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            author: currentUsername
          });
          storyStatusMessage.style.color = 'green';
          storyStatusMessage.textContent = 'Story entry submitted successfully!';
          storyForm.reset();
        }
      } catch (error) {
        storyStatusMessage.style.color = 'red';
        storyStatusMessage.textContent = 'Error submitting story entry: ' + error.message;
      }
    });
  </script>
</body>
</html>
