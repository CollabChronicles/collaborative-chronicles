<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Collaborative Chronicles</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="story.html">The Story</a> |
      <a href="lore.html">The Lore</a> |
      <a href="write.html">Write!</a> |
      <a href="profile.html">Profile</a> 
    </nav>
  </header>

  <main class="profile-container">
    <section class="profile-header">
      <h1>Your Profile</h1>
      <p><strong>Username:</strong> <span id="usernameDisplay"></span></p>
      <input type="text" id="newUsername" placeholder="Enter new username" />
      <button id="updateUsername">Update Username</button>
      <p><strong>Total Word Count:</strong> <span id="totalWordCount">0</span></p>
    </section>

    <section class="entries-section">
      <h2>Your Lore Entries</h2>
      <div id="loreEntries"></div>

      <h2>Your Story Entries</h2>
      <div id="storyEntries"></div>
    </section>

    <section id="editFormContainer" class="edit-form" style="display:none;">
      <h2>Edit Entry</h2>
      <form id="editEntryForm">
        <!-- Removed toggle buttons as requested -->
        <!-- Lore edit form -->
        <div id="editLoreForm" style="display:none;">
          <label for="editLoreName">Name:</label>
          <input type="text" id="editLoreName" required />
          <label for="editLoreCategory">Category:</label>
          <select id="editLoreCategory" required>
            <option value="">Select Category</option>
            <option value="Character">Character</option>
            <option value="Place">Place</option>
            <option value="Faction">Faction</option>
            <option value="Object">Object</option>
          </select>
          <label for="editLoreDescription">Description:</label>
          <textarea id="editLoreDescription" required></textarea>
          <label for="editLoreReferences">References (comma-separated):</label>
          <input type="text" id="editLoreReferences" required />
        </div>

        <!-- Story edit form -->
        <div id="editStoryForm" style="display:none;">
          <label for="editStoryTitle">Title:</label>
          <input type="text" id="editStoryTitle" required />
          <label for="editStoryContent">Content:</label>
          <textarea id="editStoryContent" required></textarea>
          <label for="editStoryReferences">References (comma-separated):</label>
          <input type="text" id="editStoryReferences" required />
        </div>

        <button type="submit">Save Changes</button>
        <button type="button" id="cancelEdit">Cancel</button>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Collaborative Chronicles</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  let currentEditingId = null;
  let currentEditingType = null;
  let currentUsername = "";

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const uid = user.uid;
      const userDoc = await getDoc(doc(db, "users", uid));
      currentUsername = userDoc.exists() ? userDoc.data().username : "Unknown User";
      document.getElementById("username").textContent = currentUsername;

      loadEntries("lore", "lore-entries", createLoreElement);
      loadEntries("story", "story-entries", createStoryElement);
    } else {
      window.location.href = "login.html";
    }
  });

  async function loadEntries(collectionName, containerId, createElementFn) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    const q = query(collection(db, collectionName), where("author", "==", currentUsername));
    const querySnapshot = await getDocs(q);

    querySnapshot.forEach((docSnap) => {
      const entryData = docSnap.data();
      const entryId = docSnap.id;
      const entryElement = createElementFn(entryData, entryId);
      container.appendChild(entryElement);
    });
  }

  function createLoreElement(entry, id) {
    const div = document.createElement("div");
    div.innerHTML = `
      <h3><a href="lore-detail.html?id=${id}">${entry.name}</a></h3>
      <p><strong>Category:</strong> ${entry.category}</p>
      <p>${entry.description}</p>
      <button onclick="editEntry('${id}', 'lore')">Edit</button>
      <button onclick="deleteEntry('${id}', 'lore')">Delete</button>
    `;
    return div;
  }

  function createStoryElement(entry, id) {
    const div = document.createElement("div");
    div.innerHTML = `
      <h3><a href="story-detail.html?id=${id}">${entry.title}</a></h3>
      <p>${entry.content.substring(0, 100)}...</p>
      <button onclick="editEntry('${id}', 'story')">Edit</button>
      <button onclick="deleteEntry('${id}', 'story')">Delete</button>
    `;
    return div;
  }

  window.editEntry = async function(id, type) {
    currentEditingId = id;
    currentEditingType = type;
    document.getElementById("edit-entry-section").style.display = "block";
    document.getElementById("edit-lore-form").style.display = "none";
    document.getElementById("edit-story-form").style.display = "none";

    const docRef = doc(db, type, id);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) return;

    if (type === "lore") {
      const data = docSnap.data();
      document.getElementById("edit-lore-name").value = data.name;
      document.getElementById("edit-lore-category").value = data.category;
      document.getElementById("edit-lore-description").value = data.description;
      document.getElementById("edit-lore-references").value = data.references;
      document.getElementById("edit-lore-form").style.display = "block";
    } else {
      const data = docSnap.data();
      document.getElementById("edit-story-title").value = data.title;
      document.getElementById("edit-story-content").value = data.content;
      document.getElementById("edit-story-references").value = data.references;
      document.getElementById("edit-story-form").style.display = "block";
    }
  };

  window.deleteEntry = async function(id, type) {
    if (confirm("Are you sure you want to delete this entry?")) {
      await deleteDoc(doc(db, type, id));
      loadEntries("lore", "lore-entries", createLoreElement);
      loadEntries("story", "story-entries", createStoryElement);
    }
  };

  document.getElementById("edit-entry-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!currentEditingId || !currentEditingType) return;

    if (currentEditingType === "lore") {
      const name = document.getElementById("edit-lore-name").value;
      const category = document.getElementById("edit-lore-category").value;
      const description = document.getElementById("edit-lore-description").value;
      const references = document.getElementById("edit-lore-references").value;

      await updateDoc(doc(db, "lore", currentEditingId), {
        name,
        category,
        description,
        references,
        author: currentUsername
      });
    } else {
      const title = document.getElementById("edit-story-title").value;
      const content = document.getElementById("edit-story-content").value;
      const references = document.getElementById("edit-story-references").value;

      await updateDoc(doc(db, "story", currentEditingId), {
        title,
        content,
        references,
        author: currentUsername
      });
    }

    // Reload entries after saving
    loadEntries("lore", "lore-entries", createLoreElement);
    loadEntries("story", "story-entries", createStoryElement);
    document.getElementById("edit-entry-section").style.display = "none";
    currentEditingId = null;
    currentEditingType = null;
  });
</script>

</body>
</html>
