<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile</title>
</head>
<body>
  <div id="profile-info">
    <h2>Welcome, <span id="username"></span>!</h2>
    <p>Total Word Count: <span id="word-count">0</span></p>
  </div>

  <h3>Your Lore Entries</h3>
  <div id="user-lore-list"></div>

  <h3>Your Story Entries</h3>
  <div id="user-story-list"></div>

  <!-- Edit Form -->
  <div id="edit-entry-section" style="display: none;">
    <h3>Edit Entry</h3>
    <form id="edit-entry-form">
      <input type="hidden" id="edit-entry-id" />
      <input type="hidden" id="edit-entry-type" />
      <input type="text" id="edit-entry-name" placeholder="Name" required />
      <input type="text" id="edit-entry-category" placeholder="Category" required />
      <textarea id="edit-entry-description" placeholder="Description" required></textarea>
      <button type="submit">Save Changes</button>
    </form>
  </div>

  <script type="module">
    // Top-level imports
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      getDoc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Run after DOM is ready
    window.addEventListener("DOMContentLoaded", () => {
      const firebaseConfig = {
        apiKey: "AIzaSyDTkZsxDOnakRj7nGIBOdcW7wTt0Qgb94k",
        authDomain: "collaborative-chronicles.firebaseapp.com",
        projectId: "collaborative-chronicles",
        storageBucket: "collaborative-chronicles.appspot.com",
        messagingSenderId: "568983973011",
        appId: "1:568983973011:web:db4fc6dcba3c989709f983"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth();

      const usernameSpan = document.getElementById("username");
      const wordCountSpan = document.getElementById("word-count");
      const userLoreList = document.getElementById("user-lore-list");
      const userStoryList = document.getElementById("user-story-list");

      const editSection = document.getElementById("edit-entry-section");
      const editForm = document.getElementById("edit-entry-form");
      const editId = document.getElementById("edit-entry-id");
      const editType = document.getElementById("edit-entry-type");
      const editName = document.getElementById("edit-entry-name");
      const editCategory = document.getElementById("edit-entry-category");
      const editDescription = document.getElementById("edit-entry-description");

      let currentUser;

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          usernameSpan.textContent = user.email;

          let totalWordCount = 0;

          const loreQuery = query(collection(db, "lore"), where("userId", "==", user.uid));
          const loreSnapshot = await getDocs(loreQuery);
          loreSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            totalWordCount += (data.description.match(/\w+/g) || []).length;
            const entry = createEntryElement(data, docSnap.id, 'lore');
            userLoreList.appendChild(entry);
          });

          const storyQuery = query(collection(db, "stories"), where("userId", "==", user.uid));
          const storySnapshot = await getDocs(storyQuery);
          storySnapshot.forEach(docSnap => {
            const data = docSnap.data();
            totalWordCount += (data.description.match(/\w+/g) || []).length;
            const entry = createEntryElement(data, docSnap.id, 'stories');
            userStoryList.appendChild(entry);
          });

          wordCountSpan.textContent = totalWordCount;

        } else {
          window.location.href = "login.html";
        }
      });

      function createEntryElement(entry, id, type) {
        const div = document.createElement("div");
        div.innerHTML = `
          <h3><a href="${type}-detail.html?id=${id}">${entry.name}</a></h3>
          <p><strong>Category:</strong> ${entry.category}</p>
          <p>${entry.description}</p>
          <button>Edit</button>
          <button>Delete</button>
        `;

        const [editBtn, deleteBtn] = div.querySelectorAll("button");
        editBtn.addEventListener("click", () => editEntry(id, type));
        deleteBtn.addEventListener("click", () => deleteEntry(id, type));
        return div;
      }

      async function editEntry(id, type) {
        const ref = doc(db, type, id);
        const snapshot = await getDoc(ref);
        const data = snapshot.data();

        editId.value = id;
        editType.value = type;
        editName.value = data.name;
        editCategory.value = data.category;
        editDescription.value = data.description;

        editSection.style.display = "block";
        window.scrollTo(0, editSection.offsetTop);
      }

      async function deleteEntry(id, type) {
        if (confirm("Are you sure you want to delete this entry?")) {
          await deleteDoc(doc(db, type, id));
          location.reload();
        }
      }

      editForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Ensure form is visible before proceeding
  editSection.style.display = "block";


        const id = editId.value;
        const type = editType.value;

        const ref = doc(db, type, id);
        await updateDoc(ref, {
          name: editName.value,
          category: editCategory.value,
          description: editDescription.value
        });

        location.reload();
      });
    });
  </script>
</body>
</html>
