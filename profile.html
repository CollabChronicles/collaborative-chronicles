<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Collaborative Chronicles</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="story.html">The Story</a>
      <a href="lore.html">The Lore</a>
      <a href="write.html">Write!</a>
      <a href="profile.html" class="active">Profile</a>
      <a href="terms.html">Terms</a>
    </nav>
  </header>

  <main class="profile-container">
    <section class="profile-header">
      <h1>Your Profile</h1>
      <p><strong>Username:</strong> <span id="usernameDisplay"></span></p>
      <input type="text" id="newUsername" placeholder="Enter new username" />
      <button id="updateUsername">Update Username</button>
      <p><strong>Total Word Count:</strong> <span id="totalWordCount">0</span></p>
    </section>

    <section class="entries-section">
      <h2>Your Lore Entries</h2>
      <div id="loreEntries"></div>

      <h2>Your Story Entries</h2>
      <div id="storyEntries"></div>
    </section>

    <section id="editFormContainer" class="edit-form" style="display:none;">
      <h2>Edit Entry</h2>
      <form id="editEntryForm">
        <div>
          <button type="button" id="editLoreBtn" class="active">Edit Lore</button>
          <button type="button" id="editStoryBtn">Edit Story</button>
        </div>

        <div id="editLoreForm">
          <input type="text" id="editLoreName" placeholder="Name" required />
          <select id="editLoreCategory" required>
            <option value="">Select Category</option>
            <option value="Character">Character</option>
            <option value="Place">Place</option>
            <option value="Faction">Faction</option>
            <option value="Object">Object</option>
          </select>
          <textarea id="editLoreDescription" placeholder="Description (must include all listed references)" required></textarea>
          <input type="text" id="editLoreReferences" placeholder="References (comma-separated)" required />
        </div>

        <div id="editStoryForm" style="display:none;">
          <input type="text" id="editStoryTitle" placeholder="Title" />
          <textarea id="editStoryContent" placeholder="Content (must include all listed references)" required></textarea>
          <input type="text" id="editStoryReferences" placeholder="References (comma-separated, must be recent)" required />
        </div>

        <button type="submit">Save Changes</button>
        <button type="button" id="cancelEdit">Cancel</button>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Collaborative Chronicles</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCJNGG0dKMpNwiFT-bomUR0ufSUIaoksFE",
      authDomain: "collaborative-chronicles.firebaseapp.com",
      projectId: "collaborative-chronicles",
      storageBucket: "collaborative-chronicles.appspot.com",
      messagingSenderId: "127752938400",
      appId: "1:127752938400:web:9fa9b38012352d02ed7ac5",
      measurementId: "G-0HXV6NGHQP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Elements
    const usernameDisplay = document.getElementById('usernameDisplay');
    const newUsernameInput = document.getElementById('newUsername');
    const updateUsernameBtn = document.getElementById('updateUsername');
    const totalWordCountSpan = document.getElementById('totalWordCount');
    const loreEntriesDiv = document.getElementById('loreEntries');
    const storyEntriesDiv = document.getElementById('storyEntries');
    const editFormContainer = document.getElementById('editFormContainer');
    const editEntryForm = document.getElementById('editEntryForm');

    const editLoreBtn = document.getElementById('editLoreBtn');
    const editStoryBtn = document.getElementById('editStoryBtn');
    const editLoreForm = document.getElementById('editLoreForm');
    const editStoryForm = document.getElementById('editStoryForm');

    // State
    let currentUser = null;
    let currentUsername = null;
    let currentEditingId = null;
    let currentEditingType = 'lore';

    // Helper: count words
    function countWords(text) {
      if (!text) return 0;
      return text.trim().split(/\s+/).length;
    }

    // Load user data: username from users collection by UID
    async function loadUserProfile(uid) {
      const userDoc = await db.collection('users').doc(uid).get();
      if (!userDoc.exists) {
        usernameDisplay.textContent = 'No username found';
        currentUsername = null;
      } else {
        currentUsername = userDoc.data().username;
        usernameDisplay.textContent = currentUsername;
        newUsernameInput.value = currentUsername;
      }
    }

    // Load entries by author == username
    async function loadEntries() {
      if (!currentUsername) return;
      loreEntriesDiv.innerHTML = '';
      storyEntriesDiv.innerHTML = '';

      let totalWords = 0;

      // Load lore
      const loreSnapshot = await db.collection('lore').where('author', '==', currentUsername).get();
      loreSnapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.classList.add('entry');
        div.innerHTML = `
          <h3>${data.name || '(No Name)'}</h3>
          <p>${data.description || '(No Description)'}</p>
          <button data-id="${doc.id}" data-type="lore" class="edit-btn">Edit</button>
          <button data-id="${doc.id}" data-type="lore" class="delete-btn">Delete</button>
        `;
        loreEntriesDiv.appendChild(div);
        totalWords += countWords(data.description);

        div.querySelector('.edit-btn').addEventListener('click', () => openEditForm(doc.id, 'lore', data));
        div.querySelector('.delete-btn').addEventListener('click', () => deleteEntry(doc.id, 'lore'));
      });

      // Load story
      const storySnapshot = await db.collection('story').where('author', '==', currentUsername).get();
      storySnapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.classList.add('entry');
        div.innerHTML = `
          <h3>${data.title || '(No Title)'}</h3>
          <p>${data.content || '(No Content)'}</p>
          <button data-id="${doc.id}" data-type="story" class="edit-btn">Edit</button>
          <button data-id="${doc.id}" data-type="story" class="delete-btn">Delete</button>
        `;
        storyEntriesDiv.appendChild(div);
        totalWords += countWords(data.content);

        div.querySelector('.edit-btn').addEventListener('click', () => openEditForm(doc.id, 'story', data));
        div.querySelector('.delete-btn').addEventListener('click', () => deleteEntry(doc.id, 'story'));
      });

      totalWordCountSpan.textContent = totalWords.toLocaleString();
    }

    // Open edit form with data populated
    function openEditForm(id, type, data) {
      currentEditingId = id;
      currentEditingType = type;
      editFormContainer.style.display = 'block';

      if (type === 'lore') {
        editLoreBtn.classList.add('active');
        editStoryBtn.classList.remove('active');
        editLoreForm.style.display = 'block';
        editStoryForm.style.display = 'none';

        document.getElementById('editLoreName').value = data.name || '';
        document.getElementById('editLoreCategory').value = data.category || '';
        document.getElementById('editLoreDescription').value = data.description || '';
        document.getElementById('editLoreReferences').value = (data.references || []).join(', ');
      } else {
        editStoryBtn.classList.add('active');
        editLoreBtn.classList.remove('active');
        editStoryForm.style.display = 'block';
        editLoreForm.style.display = 'none';

        document.getElementById('editStoryTitle').value = data.title || '';
        document.getElementById('editStoryContent').value = data.content || '';
        document.getElementById('editStoryReferences').value = (data.references || []).join(', ');
      }
    }

    // Delete an entry
    async function deleteEntry(id, type) {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      try {
        await db.collection(type).doc(id).delete();
        alert('Entry deleted.');
        loadEntries();
      } catch (e) {
        alert('Error deleting entry: ' + e.message);
      }
    }

    // Form toggles
    editLoreBtn.addEventListener('click', () => {
      currentEditingType = 'lore';
      editLoreBtn.classList.add('active');
      editStoryBtn.classList.remove('active');
      editLoreForm.style.display = 'block';
      editStoryForm.style.display = 'none';
    });

    editStoryBtn.addEventListener('click', () => {
      currentEditingType = 'story';
      editStoryBtn.classList.add('active');
      editLoreBtn.classList.remove('active');
      editStoryForm.style.display = 'block';
      editLoreForm.style.display = 'none';
    });

    // Cancel edit
    document.getElementById('cancelEdit').addEventListener('click', () => {
      editFormContainer.style.display = 'none';
      currentEditingId = null;
    });

    // Save edits
    editEntryForm.addEventListener('submit', async e => {
      e.preventDefault();

      try {
        if (currentEditingType === 'lore') {
          const name = document.getElementById('editLoreName').value.trim();
          const category = document.getElementById('editLoreCategory').value;
          const description = document.getElementById('editLoreDescription').value.trim();
          const references = document.getElementById('editLoreReferences').value
            .split(',')
            .map(r => r.trim())
            .filter(r => r);

          // Validate references appear in description
          const missingRefs = references.filter(r => !description.toLowerCase().includes(r.toLowerCase()));
          if (missingRefs.length) {
            alert('All references must appear in the description. Missing: ' + missingRefs.join(', '));
            return;
          }

          await db.collection('lore').doc(currentEditingId).update({
            name, category, description, references
          });
        } else {
          const title = document.getElementById('editStoryTitle').value.trim();
          const content = document.getElementById('editStoryContent').value.trim();
          const references = document.getElementById('editStoryReferences').value
            .split(',')
            .map(r => r.trim())
            .filter(r => r);

          // Validate references appear in content
          const missingRefs = references.filter(r => !content.toLowerCase().includes(r.toLowerCase()));
          if (missingRefs.length) {
            alert('All references must appear in the content. Missing: ' + missingRefs.join(', '));
            return;
          }

          // Optional: you could add recency check here for references if needed

          await db.collection('story').doc(currentEditingId).update({
            title, content, references
          });
        }
        alert('Entry updated!');
        editFormContainer.style.display = 'none';
        loadEntries();
      } catch (err) {
        alert('Error updating entry: ' + err.message);
      }
    });

    // Update username button
    updateUsernameBtn.addEventListener('click', async () => {
      const newName = newUsernameInput.value.trim();
      if (!newName) {
        alert('Username cannot be empty');
        return;
      }
      try {
        await db.collection('users').doc(currentUser.uid).update({ username: newName });
        currentUsername = newName;
        usernameDisplay.textContent = newName;
        alert('Username updated!');
        loadEntries();
      } catch (e) {
        alert('Error updating username: ' + e.message);
      }
    });

    // Listen to auth state changes
    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert('Please sign in to view your profile.');
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      await loadUserProfile(user.uid);
      await loadEntries();
    });
  </script>
</body>
</html>
