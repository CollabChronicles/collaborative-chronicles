<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="authGuard.js"></script>
  <script type="module" src="profile.js" defer></script>
</head>
<body>
  <header>
    <h1>Collaborative Chronicles</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="story.html">The Story</a>
      <a href="lore.html">The Lore</a>
      <a href="write.html">Write!</a>
      <a href="profile.html" class="active">Profile</a>
      <a href="terms.html">Terms</a>
    </nav>
  </header>

  <main class="profile-container">
    <section class="profile-header">
      <h1>Your Profile</h1>
      <p><strong>Username:</strong> <span id="usernameDisplay"></span></p>
      <input type="text" id="newUsername" placeholder="Enter new username" />
      <button id="updateUsername">Update Username</button>
      <p><strong>Total Word Count:</strong> <span id="totalWordCount">0</span></p>
    </section>

    <section class="entries-section">
      <h2>Your Lore Entries</h2>
      <div id="loreEntries"></div>

      <h2>Your Story Entries</h2>
      <div id="storyEntries"></div>
    </section>

    <section id="editFormContainer" class="edit-form hidden">
      <h2>Edit Entry</h2>
      <form id="editEntryForm">
        <div class="toggle-buttons">
          <button type="button" id="editLoreBtn" class="active">Edit Lore</button>
          <button type="button" id="editStoryBtn">Edit Story</button>
        </div>

        <div id="editLoreForm">
          <input type="text" id="editLoreName" placeholder="Name" required />
          <select id="editLoreCategory" required>
            <option value="">Select Category</option>
            <option value="Character">Character</option>
            <option value="Place">Place</option>
            <option value="Faction">Faction</option>
            <option value="Object">Object</option>
          </select>
          <textarea id="editLoreDescription" placeholder="Description (must include all listed references)" required></textarea>
          <input type="text" id="editLoreReferences" placeholder="References (comma-separated)" required />
        </div>

        <div id="editStoryForm" class="hidden">
          <input type="text" id="editStoryTitle" placeholder="Title" />
          <textarea id="editStoryContent" placeholder="Content (must include all listed references)" required></textarea>
          <input type="text" id="editStoryReferences" placeholder="References (comma-separated, must be recently used)" required />
        </div>

        <button type="submit">Save Changes</button>
        <button type="button" id="cancelEdit">Cancel</button>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Collaborative Chronicles</p>
  </footer>

  <script type="module">
    import { getRecentReferences, db, auth } from './firebaseUtils.js';

    const form = document.getElementById('editEntryForm');
    let currentEditingId = null;
    let currentType = 'lore';

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (currentType === 'lore') {
        const name = document.getElementById('editLoreName').value.trim();
        const category = document.getElementById('editLoreCategory').value;
        const description = document.getElementById('editLoreDescription').value.toLowerCase();
        const references = document.getElementById('editLoreReferences').value.toLowerCase().split(',').map(r => r.trim()).filter(r => r);

        const missingRefs = references.filter(ref => !description.includes(ref));
        if (missingRefs.length > 0) {
          alert('All references must appear in the description. Missing: ' + missingRefs.join(', '));
          return;
        }

        await db.collection('lore').doc(currentEditingId).update({ name, category, description, references });
      } else {
        const title = document.getElementById('editStoryTitle').value.trim();
        const content = document.getElementById('editStoryContent').value.toLowerCase();
        const references = document.getElementById('editStoryReferences').value.toLowerCase().split(',').map(r => r.trim()).filter(r => r);

        const missingRefs = references.filter(ref => !content.includes(ref));
        if (missingRefs.length > 0) {
          alert('All references must appear in the content. Missing: ' + missingRefs.join(', '));
          return;
        }

        const recentReferences = await getRecentReferences();
        const staleRefs = references.filter(ref => !recentReferences.includes(ref));
        if (staleRefs.length > 0) {
          alert('Some references are not recent: ' + staleRefs.join(', '));
          return;
        }

        await db.collection('story').doc(currentEditingId).update({ title, content, references });
      }

      alert('Entry successfully edited!');
      location.reload();
    });

    document.getElementById('editLoreBtn').addEventListener('click', () => {
      document.getElementById('editLoreForm').classList.remove('hidden');
      document.getElementById('editStoryForm').classList.add('hidden');
      currentType = 'lore';
    });

    document.getElementById('editStoryBtn').addEventListener('click', () => {
      document.getElementById('editStoryForm').classList.remove('hidden');
      document.getElementById('editLoreForm').classList.add('hidden');
      currentType = 'story';
    });

    document.getElementById('cancelEdit').addEventListener('click', () => {
      document.getElementById('editFormContainer').classList.add('hidden');
    });

    auth.onAuthStateChanged(async user => {
      if (!user) return;
      document.getElementById('usernameDisplay').textContent = user.displayName || user.email;

      let totalWords = 0;

      const loadEntries = async (collectionName, containerId, type) => {
        const container = document.getElementById(containerId);
        const snapshot = await db.collection(collectionName).where('uid', '==', user.uid).get();
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement('div');
          div.classList.add('entry');
          div.innerHTML = `<h3>${data.title || data.name}</h3><p>${data.description || data.content}</p><button data-id="${doc.id}" data-type="${type}" class="edit-btn">Edit</button><button data-id="${doc.id}" data-type="${type}" class="delete-btn">Delete</button>`;
          container.appendChild(div);

          const wordCount = (data.description || data.content || '').trim().split(/\s+/).length;
          totalWords += wordCount;

          div.querySelector('.edit-btn').addEventListener('click', () => {
            currentEditingId = doc.id;
            currentType = type;
            document.getElementById('editFormContainer').classList.remove('hidden');

            if (type === 'lore') {
              document.getElementById('editLoreBtn').click();
              document.getElementById('editLoreName').value = data.name;
              document.getElementById('editLoreCategory').value = data.category;
              document.getElementById('editLoreDescription').value = data.description;
              document.getElementById('editLoreReferences').value = data.references?.join(', ') || '';
            } else {
              document.getElementById('editStoryBtn').click();
              document.getElementById('editStoryTitle').value = data.title;
              document.getElementById('editStoryContent').value = data.content;
              document.getElementById('editStoryReferences').value = data.references?.join(', ') || '';
            }
          });

          div.querySelector('.delete-btn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this entry?')) {
              await db.collection(collectionName).doc(doc.id).delete();
              alert('Entry deleted.');
              location.reload();
            }
          });
        });
      };

      await loadEntries('lore', 'loreEntries', 'lore');
      await loadEntries('story', 'storyEntries', 'story');

      document.getElementById('totalWordCount').textContent = totalWords.toLocaleString();
    });
  </script>
</body>
</html>
