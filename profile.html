<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Collaborative Chronicles - Profile</title>
  <link rel="stylesheet" href="/collaborative-chronicles/style.css" />
</head>
<body>
  <header>
    <h1>Collaborative Chronicles</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="story.html">The Story</a> |
      <a href="lore.html">The Lore</a> |
      <a href="write.html">Write!</a> |
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <main>
    <!-- AUTH SECTION (Sign In / Sign Up Forms) -->
    <section id="authSection" style="display:none; max-width: 400px; margin: 0 auto;">
      <h2>Sign In to Collaborative Chronicles</h2>

      <!-- Sign In Form -->
      <form id="signInForm">
        <label for="email">Email:</label>
        <input type="text" id="email" required autocomplete="username" />

        <label for="password">Password:</label>
        <input type="password" id="password" required autocomplete="current-password" />

        <input class="button-standard" type="submit" value="Sign In" />
        <p id="signInMessage" style="color: red;"></p>
      </form>

      <p style="margin-top: 10px; text-align: center;">
        New here? <a href="#" id="showSignUp">Create an account</a>
      </p>

      <!-- Sign Up Form -->
      <form id="signUpForm" style="display:none;">
        <label for="signUpEmail">Email:</label>
        <input type="text" id="signUpEmail" required autocomplete="username" />

        <label for="signUpPassword">Password:</label>
        <input type="password" id="signUpPassword" required autocomplete="new-password" />

        <input class="button-standard" type="submit" value="Sign Up" />
        <p id="signUpMessage" style="color: red;"></p>
      </form>
    </section>

    <!-- PROFILE SECTION -->
    <section id="profileSection" style="display:none;">
      <h2>Your Profile</h2>
      <p id="userEmailOrUsername"></p>
      <button id="signOutButton" class="button-standard">Sign Out</button>

      <h3>Total Words Contributed</h3>
      <p id="totalWordCount">Loading...</p>

      <h3>Your Lore Entries</h3>
      <ul id="userLoreList">
        <li>Loading...</li>
      </ul>

      <h3>Your Story Entries</h3>
      <ul id="userStoryList">
        <li>Loading...</li>
      </ul>
    </section>
  </main>

  <footer>
    <p>2025 Collaborative Chronicles</p>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJNGG0dKMpNwiFT-bomUR0ufSUIaoksFE",
      authDomain: "collaborative-chronicles.firebaseapp.com",
      projectId: "collaborative-chronicles",
      storageBucket: "collaborative-chronicles.appspot.com",
      messagingSenderId: "127752938400",
      appId: "1:127752938400:web:9fa9b38012352d02ed7ac5",
      measurementId: "G-0HXV6NGHQP"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const authSection = document.getElementById('authSection');
    const profileSection = document.getElementById('profileSection');

    const signInForm = document.getElementById('signInForm');
    const signUpForm = document.getElementById('signUpForm');
    const showSignUpLink = document.getElementById('showSignUp');
    const signOutButton = document.getElementById('signOutButton');

    const signInMessage = document.getElementById('signInMessage');
    const signUpMessage = document.getElementById('signUpMessage');
    const userEmailOrUsername = document.getElementById('userEmailOrUsername');

    const totalWordCount = document.getElementById('totalWordCount');
    const userLoreList = document.getElementById('userLoreList');
    const userStoryList = document.getElementById('userStoryList');

    let currentUsername = null;

    // Toggle to show Sign Up form from Sign In
    showSignUpLink.addEventListener('click', (e) => {
      e.preventDefault();
      signInForm.style.display = 'none';
      signUpForm.style.display = 'block';
      signInMessage.textContent = '';
      signUpMessage.textContent = '';
    });

    // SIGN IN
    signInForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          signInForm.reset();
          signInMessage.textContent = '';
        })
        .catch((error) => {
          signInMessage.textContent = error.message;
        });
    });

    // SIGN UP
    signUpForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value.trim();

      auth.createUserWithEmailAndPassword(email, password)
        .then(async (cred) => {
          signUpForm.reset();
          signUpForm.style.display = 'none';
          signInForm.style.display = 'block';
          signUpMessage.textContent = '';

          // Optional: create a default username entry for new users in users collection
          // Using email prefix as username
          const defaultUsername = email.split('@')[0];
          await db.collection('users').doc(cred.user.uid).set({
            username: defaultUsername
          });
        })
        .catch((error) => {
          signUpMessage.textContent = error.message;
        });
    });

    // SIGN OUT
    signOutButton.addEventListener('click', () => {
      auth.signOut();
    });

    // ON AUTH STATE CHANGE
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // Signed in
        authSection.style.display = 'none';
        profileSection.style.display = 'block';

        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          currentUsername = userDoc.exists ? userDoc.data().username : user.email;
        } catch (error) {
          console.error('Error fetching user profile:', error);
          currentUsername = user.email;
        }

        userEmailOrUsername.textContent = `Signed in as: ${currentUsername}`;

        loadUserLore();
        loadUserStories();

      } else {
        // Not signed in
        authSection.style.display = 'block';
        profileSection.style.display = 'none';

        signUpForm.style.display = 'none';
        signInForm.style.display = 'block';

        signInMessage.textContent = '';
        signUpMessage.textContent = '';
        currentUsername = null;

        // Clear profile lists
        totalWordCount.textContent = '';
        userLoreList.innerHTML = '';
        userStoryList.innerHTML = '';
      }
    });

    async function loadUserLore() {
      userLoreList.innerHTML = '<li>Loading...</li>';
      try {
        const snapshot = await db.collection('lore')
          .where('author', '==', currentUsername)
          .orderBy('timestamp', 'desc')
          .get();

        if (snapshot.empty) {
          userLoreList.innerHTML = '<li>No lore entries found.</li>';
          return;
        }

        userLoreList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement('li');
          li.textContent = `${data.name} (${data.category}) - References: ${data.references.join(', ')}`;
          userLoreList.appendChild(li);
        });
      } catch (error) {
        console.error('Error loading lore:', error);
        userLoreList.innerHTML = '<li>Error loading lore entries.</li>';
      }
    }

    async function loadUserStories() {
      userStoryList.innerHTML = '<li>Loading...</li>';
      let totalWords = 0;
      try {
        const snapshot = await db.collection('story')
          .where('author', '==', currentUsername)
          .orderBy('timestamp', 'desc')
          .get();

        if (snapshot.empty) {
          userStoryList.innerHTML = '<li>No story entries found.</li>';
          totalWordCount.textContent = '0 words';
          return;
        }

        userStoryList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const words = countWords(data.content);
          totalWords += words;

          const excerpt = data.content.split(/\s+/).slice(0, 20).join(' ') + (words > 20 ? '...' : '');
          const li = document.createElement('li');
          li.textContent = `${data.name || '(Untitled)'} - ${words} words - "${excerpt}"`;
          userStoryList.appendChild(li);
        });
        totalWordCount.textContent = `${totalWords} word${totalWords !== 1 ? 's' : ''}`;
      } catch (error) {
        console.error('Error loading stories:', error);
        userStoryList.innerHTML = '<li>Error loading story entries.</li>';
        totalWordCount.textContent = 'Error';
      }
    }

    function countWords(text) {
      if (!text) return 0;
      return text.trim().split(/\s+/).length;
    }
  </script>
</body>
</html>
