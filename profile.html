<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="authGuard.js"></script>
  <script type="module" src="profile.js" defer></script>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Home</a>
      <a href="story.html">The Story</a>
      <a href="lore.html">The Lore</a>
      <a href="write.html">Write!</a>
      <a href="profile.html" class="active">Profile</a>
      <a href="terms.html">Terms</a>
    </nav>
  </header>

  <main class="profile-container">
    <section class="profile-header">
      <h1>Your Profile</h1>
      <p><strong>Username:</strong> <span id="usernameDisplay"></span></p>
      <input type="text" id="newUsername" placeholder="Enter new username" />
      <button id="updateUsername">Update Username</button>
      <p><strong>Total Word Count:</strong> <span id="totalWordCount">0</span></p>
    </section>

    <section class="entries-section">
      <h2>Your Lore Entries</h2>
      <div id="loreEntries"></div>

      <h2>Your Story Entries</h2>
      <div id="storyEntries"></div>
    </section>

    <section id="editFormContainer" class="edit-form hidden">
      <h2>Edit Entry</h2>
      <form id="editEntryForm">
        <div class="toggle-buttons">
          <button type="button" id="editLoreBtn" class="active">Edit Lore</button>
          <button type="button" id="editStoryBtn">Edit Story</button>
        </div>

        <div id="editLoreForm">
          <input type="text" id="editLoreName" placeholder="Name" required />
          <select id="editLoreCategory" required>
            <option value="">Select Category</option>
            <option value="Character">Character</option>
            <option value="Place">Place</option>
            <option value="Faction">Faction</option>
            <option value="Object">Object</option>
          </select>
          <textarea id="editLoreDescription" placeholder="Description (must include all listed references)" required></textarea>
          <input type="text" id="editLoreReferences" placeholder="References (comma-separated)" required />
        </div>

        <div id="editStoryForm" class="hidden">
          <input type="text" id="editStoryTitle" placeholder="Title" />
          <textarea id="editStoryContent" placeholder="Content (must include all listed references)" required></textarea>
          <input type="text" id="editStoryReferences" placeholder="References (comma-separated, must be recently used)" required />
        </div>

        <button type="submit">Save Changes</button>
        <button type="button" id="cancelEdit">Cancel</button>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Collaborative Chronicles</p>
  </footer>

  <script type="module">
    import { getRecentReferences } from './firebaseUtils.js';

    const form = document.getElementById('editEntryForm');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const isEditingLore = !document.getElementById('editLoreForm').classList.contains('hidden');

      if (isEditingLore) {
        const name = document.getElementById('editLoreName').value.trim();
        const category = document.getElementById('editLoreCategory').value;
        const description = document.getElementById('editLoreDescription').value.toLowerCase();
        const references = document.getElementById('editLoreReferences').value.toLowerCase().split(',').map(r => r.trim()).filter(r => r);

        const missingRefs = references.filter(ref => !description.includes(ref));

        if (missingRefs.length > 0) {
          alert('All references must appear in the description. Missing: ' + missingRefs.join(', '));
          return;
        }
      } else {
        const title = document.getElementById('editStoryTitle').value.trim();
        const content = document.getElementById('editStoryContent').value.toLowerCase();
        const references = document.getElementById('editStoryReferences').value.toLowerCase().split(',').map(r => r.trim()).filter(r => r);

        const missingRefs = references.filter(ref => !content.includes(ref));
        if (missingRefs.length > 0) {
          alert('All references must appear in the content. Missing: ' + missingRefs.join(', '));
          return;
        }

        const recentReferences = await getRecentReferences();
        const staleRefs = references.filter(ref => !recentReferences.includes(ref));

        if (staleRefs.length > 0) {
          alert('Some references are not recent: ' + staleRefs.join(', '));
          return;
        }
      }

      // Submit the edited data to Firebase here
      alert('Entry successfully edited!');
    });
  </script>
</body>
</html>
